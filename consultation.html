<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Консультация</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            padding: 8px;
            background: linear-gradient(145deg, var(--tg-theme-bg-color, #f6f6f6) 0%, var(--tg-theme-secondary-bg-color, #e0e0e0) 100%);
            color: var(--tg-theme-text-color, #000);
            min-height: 100vh;
            margin: 0;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 15px;
            padding-bottom: 100px;
            display: flex;
            flex-direction: column;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(5px);
        }
        .header {
            text-align: center;
            margin-bottom: 3px;
            animation: slideIn 0.8s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .header h1 {
            font-size: 18px;
            margin: 3px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--tg-theme-text-color, #000);
        }
        .info-text {
            text-align: center;
            margin-bottom: 10px;
            font-size: 14px;
            line-height: 1.4;
            color: var(--tg-theme-text-color, #000);
            animation: fadeInUp 0.8s ease-out;
        }
        .form-container {
            display: flex;
            flex-direction: column;
            margin-bottom: 0px;
        }
        .form-group {
            margin-bottom: 3px;
            animation: fadeInUp 0.8s ease-out forwards;
            opacity: 0;
        }
        .form-group:nth-child(1) { animation-delay: 0.1s; }
        .form-group:nth-child(2) { animation-delay: 0.2s; }
        .form-group:nth-child(3) { animation-delay: 0.3s; }
        
        @keyframes fadeInUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 14px;
            color: var(--tg-theme-text-color, #000);
        }
        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            font-size: 14px;
            background-color: rgba(255, 255, 255, 0.8);
            color: #000000 !important;
            box-sizing: border-box;
        }
        .form-input::placeholder {
            color: #666666;
        }
        .form-input:focus {
            color: #000000;
            outline: none;
            border-color: var(--tg-theme-button-color, #3390ec);
        }
        .form-textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            font-size: 14px;
            background-color: rgba(255, 255, 255, 0.8);
            color: #000000 !important;
            box-sizing: border-box;
            min-height: 80px;
            resize: vertical;
        }
        .form-textarea::placeholder {
            color: #666666;
        }
        .form-textarea:focus {
            color: #000000;
            outline: none;
            border-color: var(--tg-theme-button-color, #3390ec);
        }
        .button-container {
            display: flex;
            justify-content: space-between;
            margin-top: 0px;
            margin-bottom: 50px;
        }
        .button {
            padding: 10px 15px;
            border: none;
            border-radius: 10px;
            background-color: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            width: 48%;
            margin-top: 8px;
            position: relative;
            overflow: hidden;
            animation: slideInLeft 0.6s ease-out forwards;
            opacity: 0;
        }
        .button::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(30deg);
            transition: transform 0.5s;
            pointer-events: none;
        }
        .button:hover::after {
            transform: rotate(30deg) translate(50%, 50%);
        }
        .button:hover {
            transform: scale(1.02);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
        }
        .button:active {
            transform: scale(0.98);
            opacity: 0.8;
        }
        .back-button {
            background-color: transparent;
            color: var(--tg-theme-button-color, #3390ec);
            border: 1px solid var(--tg-theme-button-color, #3390ec);
            margin-top: 8px;
            animation: slideInRight 0.6s ease-out forwards;
            animation-delay: 0.1s;
        }
        @keyframes slideInLeft {
            from { transform: translateX(-50px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideInRight {
            from { transform: translateX(50px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .contact-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
        }
        
        .contact-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            border-radius: 10px;
            background-color: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            width: 30%;
        }
        
        .contact-button.active {
            background-color: rgba(var(--tg-theme-button-color-rgb, 51, 144, 236), 0.2);
            border-color: var(--tg-theme-button-color, #3390ec);
        }
        
        .contact-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        }
        
        .contact-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .contact-icon img {
            width: 24px;
            height: 24px;
        }
        
        .contact-label {
            font-size: 12px;
            text-align: center;
        }
        
        .country-flag {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
        }
        
        .phone-input-container {
            position: relative;
        }
        
        .phone-input {
            padding-left: 35px !important;
        }
        
        .required-field::after {
            content: '*';
            color: red;
            margin-left: 3px;
        }
        
        /* Стили для кастомных уведомлений */
        .custom-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background-color: var(--tg-theme-bg-color, #ffffff);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            max-width: 85%;
            text-align: center;
            animation: zoomIn 0.3s ease-out forwards;
            display: none;
            opacity: 0;
        }
        
        .custom-alert-icon {
            font-size: 48px;
            margin-bottom: 15px;
            display: block;
        }
        
        .custom-alert-content {
            margin-bottom: 20px;
            font-size: 16px;
            color: var(--tg-theme-text-color, #000);
            line-height: 1.4;
        }
        
        .custom-alert-button {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            background-color: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            max-width: 200px;
        }
        
        .custom-alert-button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .custom-alert-button:active {
            background-color: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #fff);
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(3px);
            z-index: 999;
            display: none;
            opacity: 0;
            animation: fadeIn 0.3s ease-out forwards;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes zoomIn {
            from { 
                opacity: 0; 
                transform: translate(-50%, -50%) scale(0.8);
            }
            to { 
                opacity: 1; 
                transform: translate(-50%, -50%) scale(1);
            }
        }
        
        /* Анимация для индикатора загрузки */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Обратная связь</h1>
        </div>
        
        <div class="info-text">
            Оставьте ваши контактные данные и мы обязательно свяжемся с Вами
        </div>
        
        <div class="form-container">
            <div class="form-group">
                <label class="form-label required-field" for="name">Ваше имя</label>
                <input type="text" id="name" class="form-input" placeholder="Введите ваше имя" onfocus="scrollToField(this)">
            </div>
            
            <div class="form-group">
                <label class="form-label required-field" for="whatsapp">WhatsApp</label>
                <div id="whatsapp-container" class="phone-input-container">
                    <div id="whatsapp-flag" class="country-flag"></div>
                    <input type="tel" id="whatsapp" class="form-input phone-input" placeholder="Введите номер WhatsApp" oninput="detectCountry('whatsapp')" onfocus="scrollToField(this)">
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label required-field" for="email-contact">Email</label>
                <input type="email" id="email-contact" class="form-input" placeholder="Введите email для связи" onfocus="scrollToField(this)">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="message">Ваш вопрос</label>
                <textarea id="message" class="form-textarea" placeholder="Опишите ваш вопрос или запрос" onfocus="scrollToField(this)"></textarea>
            </div>
        </div>
        
        <div class="button-container">
            <button class="button" onclick="submitForm()">Отправить</button>
            <button class="button back-button" onclick="goBack()">Назад</button>
        </div>
    </div>

    <!-- Кастомное уведомление -->
    <div class="overlay" id="overlay"></div>
    <div class="custom-alert" id="customAlert">
        <div class="custom-alert-icon" id="alertIcon">⚠️</div>
        <div class="custom-alert-content" id="alertContent"></div>
        <button class="custom-alert-button" id="alertButton">OK</button>
    </div>

    <!-- Индикатор загрузки -->
    <div id="loading" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; z-index: 9999;">
        <div style="background-color: white; padding: 20px; border-radius: 10px; text-align: center;">
            <div style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; margin: 0 auto; animation: spin 2s linear infinite;"></div>
            <p style="margin-top: 10px; color: #333;">Отправка данных...</p>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        
        let serviceType = '';
        let telegramUsername = '';
        
        // Коды стран и их флаги
        const countryCodes = {
            '1': 'us', // США
            '7': 'ru', // Россия
            '33': 'fr', // Франция
            '34': 'es', // Испания
            '39': 'it', // Италия
            '44': 'gb', // Великобритания
            '49': 'de', // Германия
            '55': 'br', // Бразилия
            '61': 'au', // Австралия
            '81': 'jp', // Япония
            '86': 'cn', // Китай
            '91': 'in', // Индия
            '971': 'ae', // ОАЭ
            '972': 'il', // Израиль
            '966': 'sa', // Саудовская Аравия
            '90': 'tr', // Турция
            '380': 'ua', // Украина
            '375': 'by', // Беларусь
            '998': 'uz', // Узбекистан
            '996': 'kg', // Киргизия
            '995': 'ge', // Грузия
            '994': 'az', // Азербайджан
            '993': 'tm', // Туркменистан
            '992': 'tj', // Таджикистан
            '374': 'am', // Армения
            '373': 'md', // Молдова
            '370': 'lt', // Литва
            '371': 'lv', // Латвия
            '372': 'ee', // Эстония
            '48': 'pl', // Польша
            '420': 'cz', // Чехия
            '421': 'sk', // Словакия
            '36': 'hu', // Венгрия
            '40': 'ro', // Румыния
            '359': 'bg', // Болгария
            '30': 'gr', // Греция
            '46': 'se', // Швеция
            '47': 'no', // Норвегия
            '358': 'fi', // Финляндия
            '45': 'dk', // Дания
            '31': 'nl', // Нидерланды
            '32': 'be', // Бельгия
            '41': 'ch', // Швейцария
            '43': 'at', // Австрия
            '351': 'pt', // Португалия
            '353': 'ie', // Ирландия
            '352': 'lu', // Люксембург
            '356': 'mt', // Мальта
            '357': 'cy', // Кипр
            '386': 'si', // Словения
            '385': 'hr', // Хорватия
            '381': 'rs', // Сербия
            '355': 'al', // Албания
            '389': 'mk', // Северная Македония
            '387': 'ba', // Босния и Герцеговина
            '382': 'me', // Черногория
            '377': 'mc', // Монако
            '376': 'ad', // Андорра
            '378': 'sm', // Сан-Марино
            '379': 'va', // Ватикан
            '350': 'gi', // Гибралтар
            '354': 'is', // Исландия
            '298': 'fo', // Фарерские острова
            '299': 'gl', // Гренландия
            '213': 'dz', // Алжир
            '20': 'eg', // Египет
            '212': 'ma', // Марокко
            '216': 'tn', // Тунис
            '218': 'ly', // Ливия
            '249': 'sd', // Судан
            '251': 'et', // Эфиопия
            '254': 'ke', // Кения
            '255': 'tz', // Танзания
            '256': 'ug', // Уганда
            '260': 'zm', // Замбия
            '263': 'zw', // Зимбабве
            '27': 'za', // ЮАР
            '234': 'ng', // Нигерия
            '233': 'gh', // Гана
            '225': 'ci', // Кот-д'Ивуар
            '221': 'sn', // Сенегал
            '237': 'cm', // Камерун
            '244': 'ao', // Ангола
            '250': 'rw', // Руанда
            '241': 'ga', // Габон
            '242': 'cg', // Конго
            '243': 'cd', // ДР Конго
            '235': 'td', // Чад
            '236': 'cf', // ЦАР
            '238': 'cv', // Кабо-Верде
            '240': 'gq', // Экваториальная Гвинея
            '245': 'gw', // Гвинея-Бисау
            '247': 'sh', // Остров Святой Елены
            '248': 'sc', // Сейшельские острова
            '252': 'so', // Сомали
            '253': 'dj', // Джибути
            '257': 'bi', // Бурунди
            '258': 'mz', // Мозамбик
            '261': 'mg', // Мадагаскар
            '262': 're', // Реюньон
            '264': 'na', // Намибия
            '265': 'mw', // Малави
            '266': 'ls', // Лесото
            '267': 'bw', // Ботсвана
            '268': 'sz', // Свазиленд
            '269': 'km', // Коморские острова
            '290': 'sh', // Остров Святой Елены
            '291': 'er', // Эритрея
            '297': 'aw', // Аруба
            '501': 'bz', // Белиз
            '502': 'gt', // Гватемала
            '503': 'sv', // Сальвадор
            '504': 'hn', // Гондурас
            '505': 'ni', // Никарагуа
            '506': 'cr', // Коста-Рика
            '507': 'pa', // Панама
            '509': 'ht', // Гаити
            '51': 'pe', // Перу
            '52': 'mx', // Мексика
            '53': 'cu', // Куба
            '54': 'ar', // Аргентина
            '56': 'cl', // Чили
            '57': 'co', // Колумбия
            '58': 've', // Венесуэла
            '591': 'bo', // Боливия
            '592': 'gy', // Гайана
            '593': 'ec', // Эквадор
            '595': 'py', // Парагвай
            '597': 'sr', // Суринам
            '598': 'uy', // Уругвай
            '599': 'an', // Нидерландские Антильские острова
            '60': 'my', // Малайзия
            '62': 'id', // Индонезия
            '63': 'ph', // Филиппины
            '64': 'nz', // Новая Зеландия
            '65': 'sg', // Сингапур
            '66': 'th', // Таиланд
            '673': 'bn', // Бруней
            '674': 'nr', // Науру
            '675': 'pg', // Папуа-Новая Гвинея
            '676': 'to', // Тонга
            '677': 'sb', // Соломоновы острова
            '678': 'vu', // Вануату
            '679': 'fj', // Фиджи
            '680': 'pw', // Палау
            '681': 'wf', // Уоллис и Футуна
            '682': 'ck', // Острова Кука
            '683': 'nu', // Ниуэ
            '684': 'as', // Американское Самоа
            '685': 'ws', // Самоа
            '686': 'ki', // Кирибати
            '687': 'nc', // Новая Каледония
            '688': 'tv', // Тувалу
            '689': 'pf', // Французская Полинезия
            '690': 'tk', // Токелау
            '691': 'fm', // Микронезия
            '692': 'mh', // Маршалловы острова
            '850': 'kp', // Северная Корея
            '852': 'hk', // Гонконг
            '853': 'mo', // Макао
            '855': 'kh', // Камбоджа
            '856': 'la', // Лаос
            '880': 'bd', // Бангладеш
            '886': 'tw', // Тайвань
            '960': 'mv', // Мальдивы
            '961': 'lb', // Ливан
            '962': 'jo', // Иордания
            '963': 'sy', // Сирия
            '964': 'iq', // Ирак
            '965': 'kw', // Кувейт
            '967': 'ye', // Йемен
            '968': 'om', // Оман
            '970': 'ps', // Палестина
            '973': 'bh', // Бахрейн
            '974': 'qa', // Катар
            '975': 'bt', // Бутан
            '976': 'mn', // Монголия
            '977': 'np', // Непал
            '98': 'ir', // Иран
            '992': 'tj', // Таджикистан
            '994': 'az', // Азербайджан
            '995': 'ge', // Грузия
            '996': 'kg', // Киргизия
            '998': 'uz'  // Узбекистан
        };
        
        // Получаем тип услуги из URL параметров
        function getServiceFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('service') || '';
        }
        
        // Инициализация при загрузке страницы
        window.onload = function() {
            serviceType = getServiceFromUrl();
            
            // Получаем данные пользователя Telegram
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                telegramUsername = tg.initDataUnsafe.user.username || '';
                console.log('Telegram username:', telegramUsername);
            }
            
            // Если есть данные ипотеки в localStorage, получаем их
            if (serviceType === 'mortgage') {
                const mortgageData = JSON.parse(localStorage.getItem('mortgage_data') || '{}');
                console.log('Mortgage data:', mortgageData);
            }
            
            // Добавляем обработчик ввода для определения страны
            document.getElementById('whatsapp').addEventListener('input', function() {
                detectCountry('whatsapp');
            });
        };
        
        // Определение страны по коду телефона
        function detectCountry(inputId) {
            const phoneInput = document.getElementById(inputId);
            const countryFlag = document.getElementById(inputId + '-flag');
            
            let phone = phoneInput.value.replace(/\D/g, '');
            
            if (phone.startsWith('00')) {
                phone = phone.substring(2);
            } else if (phone.startsWith('+')) {
                phone = phone.substring(1);
            }
            
            // Проверяем все возможные коды стран от самых длинных до коротких
            let countryCode = '';
            let countryISO = '';
            
            // Сортируем коды по длине (от длинных к коротким)
            const sortedCodes = Object.keys(countryCodes).sort((a, b) => b.length - a.length);
            
            for (const code of sortedCodes) {
                if (phone.startsWith(code)) {
                    countryCode = code;
                    countryISO = countryCodes[code];
                    break;
                }
            }
            
            // Функция для преобразования ISO кода страны в эмодзи флага
            function getCountryFlagEmoji(countryCode) {
                const codePoints = countryCode
                    .toUpperCase()
                    .split('')
                    .map(char => 127397 + char.charCodeAt());
                return String.fromCodePoint(...codePoints);
            }
            
            if (countryISO) {
                // Используем эмодзи флага вместо изображения
                const flagEmoji = getCountryFlagEmoji(countryISO);
                countryFlag.textContent = flagEmoji;
                countryFlag.style.display = 'block';
                console.log(`Установлен флаг для страны: ${countryISO} (${flagEmoji})`);
            } else {
                countryFlag.textContent = '';
                countryFlag.style.display = 'none';
                console.log('Страна не определена');
            }
        }
        
        // Функция для отправки сообщения в Telegram бота
        async function sendToTelegramBot(data) {
            try {
                const BOT_TOKEN = '7671516191:AAE_MnEADtr6MY7wRqIvu8DHdGaL9bJAlbk';
                // Массив ID администраторов
                const ADMIN_IDS = ['5467140250', '1621625897'];
                
                console.log('Подготовка к отправке сообщения администраторам:', ADMIN_IDS);
                
                // Формируем текст сообщения с красивым форматированием
                let messageText = `📋 *НОВАЯ ЗАЯВКА* 📋\n\n`;
                messageText += `🔹 *Услуга:* ${getServiceName(data.service)}\n`;
                messageText += `👤 *Имя:* ${data.name}\n`;
                messageText += `📱 *WhatsApp:* ${data.whatsapp}\n`;
                messageText += `📧 *Email:* ${data.email}\n`;
                
                // Добавляем Telegram username, если он доступен
                if (data.telegramUsername) {
                    messageText += `💬 *Telegram:* @${data.telegramUsername}\n`;
                }
                
                if (data.message && data.message.trim()) {
                    messageText += `\n📝 *Сообщение клиента:*\n_${data.message.trim()}_\n`;
                }
                
                // Добавляем данные ипотеки, если они есть
                if (data.service === 'mortgage' && data.budget) {
                    messageText += `\n🏠 *ДАННЫЕ ПО ИПОТЕКЕ:*\n`;
                    messageText += `💰 *Бюджет:* ${new Intl.NumberFormat('ru-RU').format(data.budget)} $\n`;
                    messageText += `🏢 *Стоимость недвижимости:* ${new Intl.NumberFormat('ru-RU').format(data.propertyCost)} $\n`;
                    messageText += `👨‍👩‍👧 *Возраст:* ${data.age} лет\n`;
                }
                
                // Добавляем дату и время
                const now = new Date();
                const dateOptions = { day: '2-digit', month: '2-digit', year: 'numeric' };
                const timeOptions = { hour: '2-digit', minute: '2-digit' };
                const dateStr = now.toLocaleDateString('ru-RU', dateOptions);
                const timeStr = now.toLocaleTimeString('ru-RU', timeOptions);
                
                messageText += `\n📅 *Дата:* ${dateStr}\n⏰ *Время:* ${timeStr}`;
                
                console.log('Подготовленное сообщение:', messageText);
                
                // Создаем скрытый div для хранения элементов
                const container = document.createElement('div');
                container.style.display = 'none';
                document.body.appendChild(container);
                
                // Отправляем сообщения администраторам
                let successCount = 0;
                
                for (const adminId of ADMIN_IDS) {
                    try {
                        const encodedText = encodeURIComponent(messageText);
                        const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${adminId}&text=${encodedText}&parse_mode=Markdown&disable_web_page_preview=true`;
                        
                        // Используем fetch для отправки запроса
                        fetch(url)
                            .then(response => {
                                console.log(`Сообщение отправлено админу ${adminId}, статус:`, response.status);
                                return response.json();
                            })
                            .then(data => {
                                console.log(`Ответ от API для админа ${adminId}:`, data);
                                successCount++;
                            })
                            .catch(error => {
                                console.error(`Ошибка при отправке сообщения админу ${adminId}:`, error);
                                
                                // Пробуем альтернативный метод через img
                                try {
                                    console.log(`Пробуем отправить через альтернативный метод админу ${adminId}...`);
                                    
                                    // Создаем img элемент
                                    const img = document.createElement('img');
                                    img.style.display = 'none';
                                    img.src = url;
                                    container.appendChild(img);
                                    
                                    console.log(`Альтернативный метод отправки админу ${adminId} запущен`);
                                    successCount++;
                                } catch (altError) {
                                    console.error(`Ошибка при использовании альтернативного метода для админа ${adminId}:`, altError);
                                }
                            });
                    } catch (e) {
                        console.error(`Ошибка при создании запроса для админа ${adminId}:`, e);
                    }
                }
                
                // Удаляем контейнер через 5 секунд
                setTimeout(() => {
                    if (container && container.parentNode) {
                        document.body.removeChild(container);
                    }
                }, 5000);
                
                // Всегда возвращаем true, чтобы не блокировать пользовательский интерфейс
                return true;
            } catch (error) {
                console.error("Глобальная ошибка в функции sendToTelegramBot:", error);
                // Всегда возвращаем true, даже при ошибке
                return true;
            }
        }
        
        // Получение названия услуги для сообщения
        function getServiceName(serviceCode) {
            const services = {
                'mortgage': 'Ипотека',
                'visa': 'Виза',
                'bank': 'Счет в банке',
                'lawyer': 'Юридические услуги',
                'company': 'Открытие компании',
                'consultation': 'Консультация'
            };
            return services[serviceCode] || 'Неизвестная услуга';
        }
        
        async function submitForm() {
            const name = document.getElementById('name').value;
            const whatsapp = document.getElementById('whatsapp').value;
            const email = document.getElementById('email-contact').value;
            const message = document.getElementById('message').value;
            
            if (!name) {
                showCustomAlert('Пожалуйста, введите ваше имя', 'warning');
                return;
            }
            
            if (!whatsapp) {
                showCustomAlert('Пожалуйста, введите номер WhatsApp', 'warning');
                return;
            }
            
            if (!email) {
                showCustomAlert('Пожалуйста, введите email для связи', 'warning');
                return;
            }
            
            // Проверка формата email
            if (email && !isValidEmail(email)) {
                showCustomAlert('Пожалуйста, введите корректный email', 'warning');
                return;
            }
            
            // Подготавливаем данные для отправки
            const data = {
                service: serviceType || 'consultation',
                name: name,
                whatsapp: whatsapp,
                email: email,
                message: message,
                telegramUsername: telegramUsername,
                timestamp: Date.now()
            };
            
            // Если есть данные ипотеки, добавляем их
            if (serviceType === 'mortgage') {
                const mortgageData = JSON.parse(localStorage.getItem('mortgage_data') || '{}');
                Object.assign(data, mortgageData);
                
                // Очищаем localStorage
                localStorage.removeItem('mortgage_data');
            }
            
            // Отправляем данные в Telegram бота
            const sentToBot = await sendToTelegramBot(data);
            
            // Показываем сообщение об успешной отправке
            if (sentToBot) {
                showCustomAlert('Ваша заявка успешно отправлена! Мы свяжемся с вами в ближайшее время.', 'success');
                
                // Очищаем форму после успешной отправки
                document.getElementById('name').value = '';
                document.getElementById('whatsapp').value = '';
                document.getElementById('email-contact').value = '';
                document.getElementById('message').value = '';
                
                // Возвращаемся на главную страницу вместо закрытия приложения
                setTimeout(() => {
                    const currentPath = window.location.pathname;
                    const basePath = currentPath.substring(0, currentPath.lastIndexOf('/'));
                    window.location.href = `${basePath}/index.html`;
                }, 2000);
            } else {
                showCustomAlert('Произошла ошибка при отправке заявки. Пожалуйста, попробуйте еще раз.', 'error');
            }
        }
        
        // Проверка валидности email
        function isValidEmail(email) {
            const re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            return re.test(String(email).toLowerCase());
        }
        
        function goBack() {
            window.history.back();
        }
        
        // Функция для прокрутки страницы при фокусе на поле ввода
        function scrollToField(element) {
            // Небольшая задержка для корректной работы на мобильных устройствах
            setTimeout(() => {
                // Получаем позицию элемента относительно верха страницы
                const rect = element.getBoundingClientRect();
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const offsetTop = rect.top + scrollTop;
                
                // Прокручиваем страницу так, чтобы поле ввода было в верхней части экрана
                // Это поможет избежать перекрытия клавиатурой
                window.scrollTo({
                    top: offsetTop - 100, // Отступ сверху для удобства
                    behavior: 'smooth'
                });
            }, 300);
        }
        
        // Добавляем обработчики событий для скрытия клавиатуры при нажатии на кнопки
        document.querySelectorAll('.button').forEach(button => {
            button.addEventListener('touchstart', function() {
                // Снимаем фокус с активного элемента для скрытия клавиатуры
                document.activeElement.blur();
            });
        });
        
        // Функция для показа кастомного уведомления
        function showCustomAlert(message, type = 'info') {
            const overlay = document.getElementById('overlay');
            const customAlert = document.getElementById('customAlert');
            const alertContent = document.getElementById('alertContent');
            const alertButton = document.getElementById('alertButton');
            const alertIcon = document.getElementById('alertIcon');
            
            // Устанавливаем иконку в зависимости от типа уведомления
            if (type === 'success') {
                alertIcon.textContent = '✅';
            } else if (type === 'error') {
                alertIcon.textContent = '❌';
            } else if (type === 'warning') {
                alertIcon.textContent = '⚠️';
            } else {
                alertIcon.textContent = 'ℹ️';
            }
            
            alertContent.textContent = message;
            overlay.style.display = 'block';
            customAlert.style.display = 'block';
            
            // Сбрасываем анимацию
            overlay.style.animation = 'none';
            customAlert.style.animation = 'none';
            
            // Запускаем анимацию
            setTimeout(() => {
                overlay.style.animation = 'fadeIn 0.3s ease-out forwards';
                customAlert.style.animation = 'zoomIn 0.3s ease-out forwards';
            }, 10);
            
            alertButton.onclick = function() {
                overlay.style.opacity = '0';
                customAlert.style.opacity = '0';
                
                setTimeout(() => {
                    overlay.style.display = 'none';
                    customAlert.style.display = 'none';
                }, 300);
            };
        }
    </script>
</body>
</html> 