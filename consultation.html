<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Консультация</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            padding: 8px;
            background: linear-gradient(145deg, var(--tg-theme-bg-color, #f6f6f6) 0%, var(--tg-theme-secondary-bg-color, #e0e0e0) 100%);
            color: var(--tg-theme-text-color, #000);
            min-height: 100vh;
            margin: 0;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .container {
            max-width: 450px;
            margin: 0 auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(5px);
        }
        .header {
            text-align: center;
            margin-bottom: 5px;
            animation: slideIn 0.8s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .header h1 {
            font-size: 18px;
            margin: 3px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--tg-theme-text-color, #000);
        }
        .info-text {
            text-align: center;
            margin-bottom: 15px;
            font-size: 14px;
            line-height: 1.4;
            color: var(--tg-theme-text-color, #000);
            animation: fadeInUp 0.8s ease-out;
        }
        .form-container {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
        }
        .form-group {
            margin-bottom: 10px;
            animation: fadeInUp 0.8s ease-out forwards;
            opacity: 0;
        }
        .form-group:nth-child(1) { animation-delay: 0.1s; }
        .form-group:nth-child(2) { animation-delay: 0.2s; }
        .form-group:nth-child(3) { animation-delay: 0.3s; }
        
        @keyframes fadeInUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 14px;
            color: var(--tg-theme-text-color, #000);
        }
        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            font-size: 14px;
            background-color: rgba(255, 255, 255, 0.8);
            color: var(--tg-theme-text-color, #000);
            box-sizing: border-box;
        }
        .form-textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            font-size: 14px;
            background-color: rgba(255, 255, 255, 0.8);
            color: var(--tg-theme-text-color, #000);
            box-sizing: border-box;
            min-height: 80px;
            resize: vertical;
        }
        .button-container {
            margin-top: 5px;
            flex: 0 0 auto;
        }
        .button {
            padding: 10px 15px;
            border: none;
            border-radius: 10px;
            background-color: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            width: 100%;
            margin-top: 8px;
            position: relative;
            overflow: hidden;
            animation: slideInLeft 0.6s ease-out forwards;
            opacity: 0;
        }
        .button::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(30deg);
            transition: transform 0.5s;
            pointer-events: none;
        }
        .button:hover::after {
            transform: rotate(30deg) translate(50%, 50%);
        }
        .button:hover {
            transform: scale(1.02);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
        }
        .button:active {
            transform: scale(0.98);
            opacity: 0.8;
        }
        .back-button {
            background-color: transparent;
            color: var(--tg-theme-button-color, #3390ec);
            border: 1px solid var(--tg-theme-button-color, #3390ec);
            margin-top: 5px;
            animation: slideInRight 0.6s ease-out forwards;
            animation-delay: 0.1s;
        }
        @keyframes slideInLeft {
            from { transform: translateX(-50px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideInRight {
            from { transform: translateX(50px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .contact-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
        }
        
        .contact-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            border-radius: 10px;
            background-color: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            width: 30%;
        }
        
        .contact-button.active {
            background-color: rgba(var(--tg-theme-button-color-rgb, 51, 144, 236), 0.2);
            border-color: var(--tg-theme-button-color, #3390ec);
        }
        
        .contact-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        }
        
        .contact-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .contact-icon img {
            width: 24px;
            height: 24px;
        }
        
        .contact-label {
            font-size: 12px;
            text-align: center;
        }
        
        .country-flag {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
        }
        
        .phone-input-container {
            position: relative;
        }
        
        .phone-input {
            padding-left: 35px !important;
        }
        
        .required-field::after {
            content: '*';
            color: red;
            margin-left: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Обратная связь</h1>
        </div>
        
        <div class="info-text">
            Оставьте ваши контактные данные и мы обязательно свяжемся с Вами
        </div>
        
        <div class="form-container">
            <div class="form-group">
                <label class="form-label required-field" for="name">Ваше имя</label>
                <input type="text" id="name" class="form-input" placeholder="Введите ваше имя">
            </div>
            
            <div class="form-group">
                <label class="form-label required-field" for="whatsapp">WhatsApp</label>
                <div id="whatsapp-container" class="phone-input-container">
                    <div id="whatsapp-flag" class="country-flag"></div>
                    <input type="tel" id="whatsapp" class="form-input phone-input" placeholder="Введите номер WhatsApp" oninput="detectCountry('whatsapp')">
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label required-field" for="email-contact">Email</label>
                <input type="email" id="email-contact" class="form-input" placeholder="Введите email для связи">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="message">Ваш вопрос</label>
                <textarea id="message" class="form-textarea" placeholder="Опишите ваш вопрос или запрос"></textarea>
            </div>
        </div>
        
        <div class="button-container">
            <button class="button" onclick="submitForm()">Отправить</button>
            <button class="button back-button" onclick="goBack()">Назад</button>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        
        let serviceType = '';
        let telegramUsername = '';
        
        // Коды стран и их флаги
        const countryCodes = {
            '1': 'us', // США
            '7': 'ru', // Россия
            '33': 'fr', // Франция
            '34': 'es', // Испания
            '39': 'it', // Италия
            '44': 'gb', // Великобритания
            '49': 'de', // Германия
            '55': 'br', // Бразилия
            '61': 'au', // Австралия
            '81': 'jp', // Япония
            '86': 'cn', // Китай
            '91': 'in', // Индия
            '971': 'ae', // ОАЭ
            '972': 'il', // Израиль
            '966': 'sa', // Саудовская Аравия
            '90': 'tr', // Турция
            '380': 'ua', // Украина
            '375': 'by', // Беларусь
            '998': 'uz', // Узбекистан
            '996': 'kg', // Киргизия
            '995': 'ge', // Грузия
            '994': 'az', // Азербайджан
            '993': 'tm', // Туркменистан
            '992': 'tj', // Таджикистан
            '374': 'am', // Армения
            '373': 'md', // Молдова
            '370': 'lt', // Литва
            '371': 'lv', // Латвия
            '372': 'ee', // Эстония
            '48': 'pl', // Польша
            '420': 'cz', // Чехия
            '421': 'sk', // Словакия
            '36': 'hu', // Венгрия
            '40': 'ro', // Румыния
            '359': 'bg', // Болгария
            '30': 'gr', // Греция
            '46': 'se', // Швеция
            '47': 'no', // Норвегия
            '358': 'fi', // Финляндия
            '45': 'dk', // Дания
            '31': 'nl', // Нидерланды
            '32': 'be', // Бельгия
            '41': 'ch', // Швейцария
            '43': 'at', // Австрия
            '351': 'pt', // Португалия
            '353': 'ie', // Ирландия
            '352': 'lu', // Люксембург
            '356': 'mt', // Мальта
            '357': 'cy', // Кипр
            '386': 'si', // Словения
            '385': 'hr', // Хорватия
            '381': 'rs', // Сербия
            '355': 'al', // Албания
            '389': 'mk', // Северная Македония
            '387': 'ba', // Босния и Герцеговина
            '382': 'me', // Черногория
            '377': 'mc', // Монако
            '376': 'ad', // Андорра
            '378': 'sm', // Сан-Марино
            '379': 'va', // Ватикан
            '350': 'gi', // Гибралтар
            '354': 'is', // Исландия
            '298': 'fo', // Фарерские острова
            '299': 'gl', // Гренландия
            '213': 'dz', // Алжир
            '20': 'eg', // Египет
            '212': 'ma', // Марокко
            '216': 'tn', // Тунис
            '218': 'ly', // Ливия
            '249': 'sd', // Судан
            '251': 'et', // Эфиопия
            '254': 'ke', // Кения
            '255': 'tz', // Танзания
            '256': 'ug', // Уганда
            '260': 'zm', // Замбия
            '263': 'zw', // Зимбабве
            '27': 'za', // ЮАР
            '234': 'ng', // Нигерия
            '233': 'gh', // Гана
            '225': 'ci', // Кот-д'Ивуар
            '221': 'sn', // Сенегал
            '237': 'cm', // Камерун
            '244': 'ao', // Ангола
            '250': 'rw', // Руанда
            '241': 'ga', // Габон
            '242': 'cg', // Конго
            '243': 'cd', // ДР Конго
            '235': 'td', // Чад
            '236': 'cf', // ЦАР
            '238': 'cv', // Кабо-Верде
            '240': 'gq', // Экваториальная Гвинея
            '245': 'gw', // Гвинея-Бисау
            '247': 'sh', // Остров Святой Елены
            '248': 'sc', // Сейшельские острова
            '252': 'so', // Сомали
            '253': 'dj', // Джибути
            '257': 'bi', // Бурунди
            '258': 'mz', // Мозамбик
            '261': 'mg', // Мадагаскар
            '262': 're', // Реюньон
            '264': 'na', // Намибия
            '265': 'mw', // Малави
            '266': 'ls', // Лесото
            '267': 'bw', // Ботсвана
            '268': 'sz', // Свазиленд
            '269': 'km', // Коморские острова
            '290': 'sh', // Остров Святой Елены
            '291': 'er', // Эритрея
            '297': 'aw', // Аруба
            '501': 'bz', // Белиз
            '502': 'gt', // Гватемала
            '503': 'sv', // Сальвадор
            '504': 'hn', // Гондурас
            '505': 'ni', // Никарагуа
            '506': 'cr', // Коста-Рика
            '507': 'pa', // Панама
            '509': 'ht', // Гаити
            '51': 'pe', // Перу
            '52': 'mx', // Мексика
            '53': 'cu', // Куба
            '54': 'ar', // Аргентина
            '56': 'cl', // Чили
            '57': 'co', // Колумбия
            '58': 've', // Венесуэла
            '591': 'bo', // Боливия
            '592': 'gy', // Гайана
            '593': 'ec', // Эквадор
            '595': 'py', // Парагвай
            '597': 'sr', // Суринам
            '598': 'uy', // Уругвай
            '599': 'an', // Нидерландские Антильские острова
            '60': 'my', // Малайзия
            '62': 'id', // Индонезия
            '63': 'ph', // Филиппины
            '64': 'nz', // Новая Зеландия
            '65': 'sg', // Сингапур
            '66': 'th', // Таиланд
            '673': 'bn', // Бруней
            '674': 'nr', // Науру
            '675': 'pg', // Папуа-Новая Гвинея
            '676': 'to', // Тонга
            '677': 'sb', // Соломоновы острова
            '678': 'vu', // Вануату
            '679': 'fj', // Фиджи
            '680': 'pw', // Палау
            '681': 'wf', // Уоллис и Футуна
            '682': 'ck', // Острова Кука
            '683': 'nu', // Ниуэ
            '684': 'as', // Американское Самоа
            '685': 'ws', // Самоа
            '686': 'ki', // Кирибати
            '687': 'nc', // Новая Каледония
            '688': 'tv', // Тувалу
            '689': 'pf', // Французская Полинезия
            '690': 'tk', // Токелау
            '691': 'fm', // Микронезия
            '692': 'mh', // Маршалловы острова
            '850': 'kp', // Северная Корея
            '852': 'hk', // Гонконг
            '853': 'mo', // Макао
            '855': 'kh', // Камбоджа
            '856': 'la', // Лаос
            '880': 'bd', // Бангладеш
            '886': 'tw', // Тайвань
            '960': 'mv', // Мальдивы
            '961': 'lb', // Ливан
            '962': 'jo', // Иордания
            '963': 'sy', // Сирия
            '964': 'iq', // Ирак
            '965': 'kw', // Кувейт
            '967': 'ye', // Йемен
            '968': 'om', // Оман
            '970': 'ps', // Палестина
            '973': 'bh', // Бахрейн
            '974': 'qa', // Катар
            '975': 'bt', // Бутан
            '976': 'mn', // Монголия
            '977': 'np', // Непал
            '98': 'ir', // Иран
            '992': 'tj', // Таджикистан
            '994': 'az', // Азербайджан
            '995': 'ge', // Грузия
            '996': 'kg', // Киргизия
            '998': 'uz'  // Узбекистан
        };
        
        // Получаем тип услуги из URL параметров
        function getServiceFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('service') || '';
        }
        
        // Инициализация при загрузке страницы
        window.onload = function() {
            serviceType = getServiceFromUrl();
            
            // Получаем данные пользователя Telegram
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                telegramUsername = tg.initDataUnsafe.user.username || '';
                console.log('Telegram username:', telegramUsername);
            }
            
            // Если есть данные ипотеки в localStorage, получаем их
            if (serviceType === 'mortgage') {
                const mortgageData = JSON.parse(localStorage.getItem('mortgage_data') || '{}');
                console.log('Mortgage data:', mortgageData);
            }
            
            // Добавляем обработчик ввода для определения страны
            document.getElementById('whatsapp').addEventListener('input', function() {
                detectCountry('whatsapp');
            });
        };
        
        // Определение страны по коду телефона
        function detectCountry(inputId) {
            const phoneInput = document.getElementById(inputId);
            const countryFlag = document.getElementById(inputId + '-flag');
            
            let phone = phoneInput.value.replace(/\D/g, '');
            
            if (phone.startsWith('00')) {
                phone = phone.substring(2);
            } else if (phone.startsWith('+')) {
                phone = phone.substring(1);
            }
            
            // Проверяем все возможные коды стран от самых длинных до коротких
            let countryCode = '';
            let countryISO = '';
            
            // Сортируем коды по длине (от длинных к коротким)
            const sortedCodes = Object.keys(countryCodes).sort((a, b) => b.length - a.length);
            
            for (const code of sortedCodes) {
                if (phone.startsWith(code)) {
                    countryCode = code;
                    countryISO = countryCodes[code];
                    break;
                }
            }
            
            // Функция для преобразования ISO кода страны в эмодзи флага
            function getCountryFlagEmoji(countryCode) {
                const codePoints = countryCode
                    .toUpperCase()
                    .split('')
                    .map(char => 127397 + char.charCodeAt());
                return String.fromCodePoint(...codePoints);
            }
            
            if (countryISO) {
                // Используем эмодзи флага вместо изображения
                const flagEmoji = getCountryFlagEmoji(countryISO);
                countryFlag.textContent = flagEmoji;
                countryFlag.style.display = 'block';
                console.log(`Установлен флаг для страны: ${countryISO} (${flagEmoji})`);
            } else {
                countryFlag.textContent = '';
                countryFlag.style.display = 'none';
                console.log('Страна не определена');
            }
        }
        
        // Функция для отправки сообщения в Telegram бота
        async function sendToTelegramBot(data) {
            const BOT_TOKEN = '7671516191:AAE_MnEADtr6MY7wRqIvu8DHdGaL9bJAlbk';
            // Массив ID администраторов
            const ADMIN_IDS = ['5467140250', '1621625897'];
            
            console.log('Подготовка к отправке сообщения администраторам:', ADMIN_IDS);
            
            // Формируем текст сообщения
            let messageText = `🔔 *Новая заявка*\n\n`;
            messageText += `*Услуга:* ${getServiceName(data.service)}\n`;
            messageText += `*Имя:* ${data.name}\n`;
            messageText += `*WhatsApp:* ${data.whatsapp}\n`;
            messageText += `*Email:* ${data.email}\n`;
            
            // Добавляем Telegram username, если он доступен
            if (data.telegramUsername) {
                messageText += `*Telegram:* @${data.telegramUsername}\n`;
            }
            
            if (data.message) {
                messageText += `*Сообщение:* ${data.message}\n`;
            }
            
            // Добавляем данные ипотеки, если они есть
            if (data.service === 'mortgage' && data.budget) {
                messageText += `\n*Данные по ипотеке:*\n`;
                messageText += `Бюджет: ${new Intl.NumberFormat('ru-RU').format(data.budget)} $\n`;
                messageText += `Стоимость недвижимости: ${new Intl.NumberFormat('ru-RU').format(data.propertyCost)} $\n`;
                messageText += `Возраст: ${data.age} лет\n`;
            }
            
            messageText += `\n📅 Дата: ${new Date().toLocaleString('ru-RU')}`;
            
            console.log('Подготовленное сообщение:', messageText);
            
            // Отправляем сообщение каждому администратору
            let successCount = 0;
            
            for (const adminId of ADMIN_IDS) {
                console.log(`Отправка сообщения администратору ${adminId}...`);
                
                try {
                    console.log('Отправка запроса к API Telegram...');
                    
                    // Отправляем запрос к API Telegram
                    const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            chat_id: adminId,
                            text: messageText,
                            parse_mode: 'Markdown'
                        })
                    });
                    
                    if (!response.ok) {
                        console.error(`Ошибка HTTP при отправке сообщения админу ${adminId}:`, response.status, response.statusText);
                        continue;
                    }
                    
                    const result = await response.json();
                    console.log(`Ответ от API Telegram для админа ${adminId}:`, result);
                    
                    if (!result.ok) {
                        console.error(`API Telegram вернул ошибку для админа ${adminId}:`, result.description);
                        continue;
                    }
                    
                    console.log(`Сообщение успешно отправлено админу ${adminId}!`);
                    successCount++;
                } catch (error) {
                    console.error(`Ошибка при отправке сообщения админу ${adminId}:`, error);
                    
                    // Попробуем альтернативный метод отправки через прокси
                    try {
                        console.log(`Пробуем отправить через альтернативный метод админу ${adminId}...`);
                        
                        // Создаем элемент iframe, который будет загружать URL для отправки сообщения
                        const iframe = document.createElement('iframe');
                        iframe.style.display = 'none';
                        document.body.appendChild(iframe);
                        
                        const encodedText = encodeURIComponent(messageText);
                        const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${adminId}&text=${encodedText}&parse_mode=Markdown`;
                        
                        iframe.src = url;
                        
                        // Удаляем iframe через 5 секунд
                        setTimeout(() => {
                            document.body.removeChild(iframe);
                            console.log(`Альтернативный метод отправки админу ${adminId} завершен`);
                        }, 5000);
                        
                        successCount++;
                    } catch (altError) {
                        console.error(`Ошибка при использовании альтернативного метода для админа ${adminId}:`, altError);
                    }
                }
            }
            
            // Если хотя бы одному администратору удалось отправить сообщение, считаем операцию успешной
            return successCount > 0;
        }
        
        // Получение названия услуги для сообщения
        function getServiceName(serviceCode) {
            const services = {
                'mortgage': 'Ипотека',
                'visa': 'Виза',
                'bank': 'Счет в банке',
                'lawyer': 'Юридические услуги',
                'company': 'Открытие компании',
                'consultation': 'Консультация'
            };
            return services[serviceCode] || 'Неизвестная услуга';
        }
        
        async function submitForm() {
            const name = document.getElementById('name').value;
            const whatsapp = document.getElementById('whatsapp').value;
            const email = document.getElementById('email-contact').value;
            const message = document.getElementById('message').value;
            
            if (!name) {
                alert('Пожалуйста, введите ваше имя');
                return;
            }
            
            if (!whatsapp) {
                alert('Пожалуйста, введите номер WhatsApp');
                return;
            }
            
            if (!email) {
                alert('Пожалуйста, введите email для связи');
                return;
            }
            
            // Проверка формата email
            if (email && !isValidEmail(email)) {
                alert('Пожалуйста, введите корректный email');
                return;
            }
            
            // Подготавливаем данные для отправки
            const data = {
                service: serviceType || 'consultation',
                name: name,
                whatsapp: whatsapp,
                email: email,
                message: message,
                telegramUsername: telegramUsername,
                timestamp: Date.now()
            };
            
            // Если есть данные ипотеки, добавляем их
            if (serviceType === 'mortgage') {
                const mortgageData = JSON.parse(localStorage.getItem('mortgage_data') || '{}');
                Object.assign(data, mortgageData);
                
                // Очищаем localStorage
                localStorage.removeItem('mortgage_data');
            }
            
            // Отправляем данные в Telegram бота
            const sentToBot = await sendToTelegramBot(data);
            
            // Показываем сообщение об успешной отправке
            if (sentToBot) {
                alert('Ваша заявка успешно отправлена! Мы свяжемся с вами в ближайшее время.');
                
                // Очищаем форму после успешной отправки
                document.getElementById('name').value = '';
                document.getElementById('whatsapp').value = '';
                document.getElementById('email-contact').value = '';
                document.getElementById('message').value = '';
                
                // Возвращаемся на главную страницу вместо закрытия приложения
                const currentPath = window.location.pathname;
                const basePath = currentPath.substring(0, currentPath.lastIndexOf('/'));
                window.location.href = `${basePath}/index.html`;
            } else {
                alert('Произошла ошибка при отправке заявки. Пожалуйста, попробуйте еще раз.');
            }
        }
        
        // Проверка валидности email
        function isValidEmail(email) {
            const re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            return re.test(String(email).toLowerCase());
        }
        
        function goBack() {
            window.history.back();
        }
    </script>
</body>
</html> 